
{% include 'header.html' %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HW7 – Pose & Hand Tracking (Holistic JS)</title>

<!-- Mediapipe Holistic (NO external model downloads required) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #fafafa;
  }
  .container {
    max-width: 1000px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  .box {
    border: 1px solid #ccc;
    background: #fdfdfd;
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 6px;
  }
  .video-wrapper {
    position: relative;
    width: 640px;
    height: 480px;
    margin: auto;
    background: black;
    border-radius: 8px;
    overflow: hidden;
  }
  #input_video { display: none; }
  #output_canvas {
    width: 100%;
    height: 100%;
  }
  button {
    padding: 10px 20px;
    margin: 6px;
    font-size: 16px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
  }
  .start { background: #1FA650; color: white; }
  .stop { background: #C62828; color: white; }
  .download { background: #1565C0; color: white; display:none; }
  textarea {
    width: 100%; height: 300px;
    font-family: monospace;
    margin-top: 10px;
    background: #f3f3f3;
  }
</style>
</head>

<body>
<div class="container">
  <h1>HW7 – Real-Time Pose & Hand Tracking (Client-side)</h1>

  <!-- REALTIME POSE HAND TRACKING -->
  <div class="box">
    <h2>Real-time Pose + Hand Tracking (Mediapipe Holistic)</h2>

    <div style="text-align:center;">
      <button class="start" onclick="startCamera()">Start Camera</button>
      <button class="stop" onclick="stopCamera()">Stop</button>
      <button class="download" id="downloadBtn" onclick="downloadCSV()">Download CSV</button>
    </div>

    <div class="video-wrapper">
      <video id="input_video"></video>
      <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <textarea id="csv_output" readonly placeholder="CSV data will appear here..."></textarea>
  </div>
</div>


<script>
const videoElement = document.getElementById("input_video");
const canvasElement = document.getElementById("output_canvas");
const canvasCtx = canvasElement.getContext("2d");
const csvBox = document.getElementById("csv_output");
const downloadBtn = document.getElementById("downloadBtn");

// State
let camera = null;
let running = false;
let startTime = 0;
let fullCSV = "time, type, id, x, y, z\n";

// Setup Holistic (POSE + HANDS)
const holistic = new Holistic({
  locateFile: (file) => "https://cdn.jsdelivr.net/npm/@mediapipe/holistic/" + file
});

holistic.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  refineFaceLandmarks: false,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

holistic.onResults(onResults);

// Start camera
function startCamera() {
  if (running) return;
  running = true;
  fullCSV = "time,type,id,x,y,z\n";
  csvBox.value = "";

  camera = new Camera(videoElement, {
    onFrame: async () => {
      if (running) await holistic.send({image: videoElement});
    },
    width: 640, height: 480
  });

  camera.start();
  startTime = Date.now();
}

// Stop camera
function stopCamera() {
  running = false;
  if (camera) {
    camera.stop();
    videoElement.srcObject?.getTracks().forEach(t => t.stop());
  }
  downloadBtn.style.display = "inline";
}

// CSV Download
function downloadCSV() {
  const blob = new Blob([fullCSV], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "hw7_realtime_pose.csv";
  a.click();
}

// Process results
function onResults(results) {
  if (!running) return;

  canvasCtx.save();
  canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);
  canvasCtx.drawImage(results.image,0,0,canvasElement.width,canvasElement.height);

  const time = ((Date.now() - startTime)/1000).toFixed(3);

  function logLandmarks(type, landmarks) {
    if (!landmarks) return;
    landmarks.forEach((lm, i) => {
      fullCSV += `${time},${type},${i},${lm.x.toFixed(4)},${lm.y.toFixed(4)},${lm.z.toFixed(4)}\n`;
    });
  }

  // Draw & log pose
  drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color:"#00FF00"});
  drawLandmarks(canvasCtx, results.poseLandmarks, {color:"#FF0000",radius:3});
  logLandmarks("POSE", results.poseLandmarks);

  // Draw & log hands
  drawConnectors(canvasCtx, results.leftHandLandmarks, HAND_CONNECTIONS, {color:"#00AAFF"});
  drawLandmarks(canvasCtx, results.leftHandLandmarks, {color:"#00AAFF",radius:3});
  logLandmarks("LEFT_HAND", results.leftHandLandmarks);

  drawConnectors(canvasCtx, results.rightHandLandmarks, HAND_CONNECTIONS, {color:"#FF8800"});
  drawLandmarks(canvasCtx, results.rightHandLandmarks, {color:"#FF8800",radius:3});
  logLandmarks("RIGHT_HAND", results.rightHandLandmarks);

  canvasCtx.restore();

  // Show only last frame
  csvBox.value = "time,type,id,x,y,z\n" + fullCSV.split("\n").slice(-50).join("\n");
}
</script>

</body>
</html>
