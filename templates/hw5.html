
{% include 'header.html' %}

<div class="container">
  <h1>HW5 â€“ Tracking (WebM Output)</h1>

  <div class="box">
    <label>Video file:</label>
    <input id="video_file" type="file" accept="video/*">

    <label>NPZ file (for SAM2):</label>
    <input id="npz_file" type="file" accept=".npz">

    <button id="btn_marker">Run Marker-Based (QR)</button>
    <button id="btn_markerless">Run Marker-less</button>
    <button id="btn_sam2">Run SAM2</button>
  </div>

  <div class="results-grid">

    <div class="box">
      <h2>Marker-Based Tracking</h2>
      <video id="vid_marker" controls style="width:100%;"></video>
      <pre id="stats_marker"></pre>
    </div>

    <div class="box">
      <h2>Marker-Less Tracking</h2>
      <video id="vid_markerless" controls style="width:100%;"></video>
      <pre id="stats_markerless"></pre>
    </div>

    <div class="box">
      <h2>SAM2 Tracking</h2>
      <video id="vid_sam2" controls style="width:100%;"></video>
      <pre id="stats_sam2"></pre>
    </div>

  </div>
</div>

<style>
  .container { max-width: 1200px; margin:auto; padding:1rem; }
  .box { border:1px solid #ccc; padding:1rem; margin-bottom:1rem; }
  .results-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(300px,1fr));
    gap:1rem;
  }
</style>

<script>
function collectData(requireNPZ=false) {
    let fd = new FormData();
    let vid = document.getElementById("video_file").files[0];
    if (!vid) { alert("Upload video first"); return null; }
    fd.append("video", vid);

    if (requireNPZ) {
        let npz = document.getElementById("npz_file").files[0];
        if (!npz) { alert("Upload NPZ first"); return null; }
        fd.append("npz", npz);
    }
    return fd;
}

function updateUI(videoElem, statsElem, data) {
    if (!data.success) {
        statsElem.textContent = "Error: " + data.error;
        videoElem.src = "";
        return;
    }
    videoElem.src = data.video + "?t=" + Date.now();
    statsElem.textContent = JSON.stringify(data.stats, null, 2);
}

document.getElementById("btn_marker").onclick = () => {
    let fd = collectData(false); if (!fd) return;
    fetch("/api/hw5_marker", {method:"POST", body:fd})
    .then(r=>r.json())
    .then(data => updateUI(
        document.getElementById("vid_marker"),
        document.getElementById("stats_marker"),
        data));
};

document.getElementById("btn_markerless").onclick = () => {
    let fd = collectData(false); if (!fd) return;
    fetch("/api/hw5_markerless", {method:"POST", body:fd})
    .then(r=>r.json())
    .then(data => updateUI(
        document.getElementById("vid_markerless"),
        document.getElementById("stats_markerless"),
        data));
};

document.getElementById("btn_sam2").onclick = () => {
    let fd = collectData(true); if (!fd) return;
    fetch("/api/hw5_sam2", {method:"POST", body:fd})
    .then(r=>r.json())
    .then(data => updateUI(
        document.getElementById("vid_sam2"),
        document.getElementById("stats_sam2"),
        data));
};
</script>
